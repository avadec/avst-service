
# Testing mode docker-compose override
# Usage: docker compose -f docker-compose.yml -f docker-compose.testing.yml up
#
# IMPORTANT LIMITATION:
# Docker Compose cannot remove the GPU 'deploy' section from docker-compose.yml when merging.
# This file will still try to use NVIDIA drivers even in testing mode.
#
# RECOMMENDED SOLUTIONS:
# - On macOS: Use docker-compose.mac.yml instead (standalone, no GPU)
# - On Linux without GPU: Remove the 'deploy' section from docker-compose.yml
# - On Linux with GPU: This file works (uses CPU via env vars, ignores GPU)
#
# This file is intended for Linux servers that HAVE GPUs installed but want to test in CPU mode.

services:
  api:
    # Override / extend environment for testing
    # Compose will merge this with the base env and override matching keys
    environment:
      TESTING_MODE: "true"
      ENABLE_STT: "false"
      ENABLE_SUMMARIZATION: "false"
      ENABLE_CALLBACK: "false"

  worker:
    # Override / extend environment for testing
    environment:
      TESTING_MODE: "true"
      ENABLE_STT: "false"
      ENABLE_SUMMARIZATION: "false"
      ENABLE_CALLBACK: "false"
      WHISPER_DEVICE: "cpu"
      WHISPER_COMPUTE_TYPE: "int8"
      LLM_DEVICE: "cpu"
    
    # Override volumes for local testing (replaces /mnt/audio with local dir)
    volumes:
      - ./test_audio:/mnt/audio:ro
      - whisper-cache:/root/.cache
      - ./testing_output.log:/app/testing_output.log
